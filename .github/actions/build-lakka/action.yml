name: Build Lakka Image
description: 'Build PSPi Recalbox image'
  
runs:
  using: "composite"
  steps:
    # Checkout repository
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
      
    # Download driver artifacts
    - name: Download Drivers
      uses: actions/download-artifact@v4
      with:
        path: rpi/drivers/bin
        merge-multiple: true

    # Install GitVersion
    - name: Install GitVersion
      uses: gittools/actions/gitversion/setup@v0
      with:
        versionSpec: '5.x'

    # Determine version
    - name: Determine Version
      id:   gitversion
      uses: gittools/actions/gitversion/execute@v0      

    # Install dependencies
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install squashfs-tools -y
      shell: bash

    # Download recalbox image
    - name: Download image files
      run: |
        # Raspberry Pi4 x64
        mkdir -p downloads
        mkdir -p images
        cd downloads
        wget -nv -O Lakka-RPi4.aarch64-5.0.img.gz "https://github.com/libretro/Lakka-LibreELEC/releases/download/v5.0/Lakka-RPi4.aarch64-5.0.img.gz"
        gunzip Lakka-RPi4.aarch64-5.0.img.gz
        mv Lakka-RPi4.aarch64-5.0.img ../images/
      working-directory: ${{ runner.temp }}
      shell: bash

    # Inject required pspi files into image
    - name: Inject files into lakka image
      run: |
        mkdir -p completed_images
        cd images
        for i in $(ls *.img)
        do
          echo "Make mount directory and mount image"
          devicePath=$(sudo losetup -f)
          sudo losetup -Pf Lakka-RPi4.aarch64-5.0.img
          sudo losetup -l
          sudo mkdir /mnt/rootfs
          sudo mount $devicePath /mnt/rootfs
          echo "Add files to /boot"
          sudo cp $GITHUB_WORKSPACE/rpi/configs/lakka/config.txt /mnt/rootfs/config.txt
          sudo cp $GITHUB_WORKSPACE/rpi/overlays/* /mnt/rootfs/overlays/
          sudo mkdir -p /mnt/rootfs/drivers
          # sudo cp $GITHUB_WORKSPACE/rpi/drivers/bin/* /mnt/rootfs/drivers/
          echo "Copy squashfs to working directory"
          cp /mnt/rootfs/SYSTEM ./SYSTEM
          echo "Unpack SYSTEM squashfs"
          unsquashfs SYSTEM
          echo "Add autostart.sh"
          cp $GITHUB_WORKSPACE/rpi/scripts/lakka/autostart_64.sh ./squashfs-root/usr/config/autostart.sh
          chmod +x ./squashfs-root/usr/config/autostart.sh
          echo "Add joypad autoconfig"
          cp $GITHUB_WORKSPACE/rpi/configs/lakka/PSPi-Controller.cfg ./squashfs-root/etc/retroarch-joypad-autoconfig/udev/PSPi-Controller.cfg
          echo "Repack squashfs"
          mksquashfs squashfs-root filesystem.squashfs -comp xz
          echo "Copy squashfs back to image"
          sudo cp filesystem.squashfs /mnt/rootfs/SYSTEM
          echo "Unmount image"
          sudo losetup -d $devicePath
          echo "Recompress image"
          xz -z "$i"
          echo "Move image to completed_images and rename"
          mv "$i.xz" ../completed_images/PSPi6.Lakka5.CM4.v${{ steps.gitversion.outputs.majorMinorPatch }}.img.xz
        done
      working-directory: ${{ runner.temp }}
      shell: bash

    # Generate sha256 filehash of image files
    - name: Generate sha256 filehash
      run: |
        for i in $(ls *.img.xz)
        do
          sha256sum "$i" | awk '{print $1}' > "$i.sha256"
        done
      working-directory: ${{ runner.temp }}/completed_images
      shell: bash

    # Update github release
    - name: Update Release
      uses: softprops/action-gh-release@v0.1.15
      with:
        generate_release_notes: true
        tag_name: v${{ steps.gitversion.outputs.majorMinorPatch }}
        name: Release v${{ steps.gitversion.outputs.majorMinorPatch }}
        draft: true
        fail_on_unmatched_files: true
        files: |
          ${{ runner.temp }}/completed_images/*.img.xz
          ${{ runner.temp }}/completed_images/*.img.xz.sha256